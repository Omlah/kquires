<!-- Modal -->
{% load i18n %}
<div class="modal fade" id="newCategoryModal" tabindex="-1" aria-labelledby="newCategoryModalLabel" aria-hidden="true">
  <form method="POST" action="{% url 'categories:create' %}" enctype="multipart/form-data">
    {% csrf_token %}
    <input type="hidden" name="id" id="id">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="newCategoryModalLabel">{% trans "New Category" %}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{% trans 'Close' %}"></button>
        </div>
        <div class="modal-body">
          <div>
            <div class="mb-3">
              <label class="form-label">{% trans "Category Type" %}</label>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="type" id="main" value="Main" required>
                <label class="form-check-label" for="main">
                  {% trans "Main" %}
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="type" id="sub" value="Sub">
                <label class="form-check-label" for="sub">
                  {% trans "Sub" %}
                </label>
              </div>
            </div>

            <div class="mb-3 logo_div">
              <label for="logo" class="form-label">{% trans "Category Logo" %}</label>
              <input type="file" name="logo" class="form-control" id="logo" placeholder="">
            </div>
            <div class="mb-3">
              <label for="name" class="form-label">{% trans "Category Name" %}</label>
              <input required type="text" name="name" class="form-control" id="name" placeholder="{% trans 'Enter Category name' %}">
            </div>

            <!-- Parent Category Dropdown -->
            <div class="mb-3 parent_category_div" style="display: none;">
              <label for="parent_category" class="form-label">{% trans "Main Category" %}</label>
              <select class="form-select" name="parent_category" id="parent_category">
                <option value="" selected hidden>{% trans "Select Main Category" %}</option>
                {% for category in parent_category %}
                  <option value="{{ category.id }}">{{ category.name }}</option>
                {% endfor %}
              </select>
            </div>

            <!-- Departments Checkbox Section (Updated) -->
                <div class="mb-3">
                  <label for="departments" class="form-label">
                    {% trans "Department" %}
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addDepartmentModal">
                      {% trans "Add" %}
                    </button>
                    <button type="button" class="btn btn-secondary" id="editDepartmentBtn" disabled data-bs-toggle="modal" data-bs-target="#editDepartmentModal">
                      {% trans "Edit" %}
                    </button>
                    <button type="button" class="btn btn-danger" id="deleteDepartmentBtn" disabled data-bs-toggle="modal" data-bs-target="#deleteConfirmationModal">
                      {% trans "Delete" %}
                    </button>
                  </label>

                  <!-- Checkbox Container -->
                  <div class="border rounded p-2" style="max-height: 200px; overflow-y: auto;">
                    <div class="mt-2" id="departmentsContainer">
                      {% for department in departments %}
                        <div class="form-check">
                          <!-- Fixed: Remove [] from name="departments" -->
                          <input 
                            class="form-check-input department-checkbox" 
                            type="checkbox" 
                            name="departments" 
                            value="{{ department.id }}" 
                            id="department_{{ department.id }}"
                            {% if department in category.departments.all %}checked{% endif %}
                          >
                          <label class="form-check-label" for="department_{{ department.id }}">
                            {{ department.name }}
                          </label>
                        </div>
                      {% endfor %}
                    </div>
                  </div>

                  <!-- Hidden Select (Updated) -->
                  <select 
                    class="form-select d-none" 
                    name="departments" 
                    id="departments" 
                    multiple
                  >
                    {% for department in departments %}
                      <option value="{{ department.id }}">{{ department.name }}</option>
                    {% endfor %}
                  </select>
                </div>




          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Close" %}</button>
          <button type="submit" class="btn btn-primary">{% trans "Save" %}</button>
        </div>
      </div>
    </div>
  </form>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmationModal" tabindex="-1" aria-labelledby="deleteConfirmationModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="deleteForm" method="POST" action="">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="deleteConfirmationModalLabel">{% trans "Confirm Delete" %}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{% trans 'Close' %}"></button>
        </div>
        <div class="modal-body">
          {% trans "Are you sure you want to delete this item? This action cannot be undone." %}
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
          <button type="submit" class="btn btn-danger">{% trans "Delete" %}</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Status Update Modal -->
<div class="modal fade" id="statusUpdateModal" tabindex="-1" aria-labelledby="statusUpdateModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="statusUpdateForm" method="POST" action="">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="statusUpdateModalLabel">{% trans "Update Status" %}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{% trans 'Close' %}"></button>
        </div>
        <div class="modal-body">
          {% trans "Are you sure you want to update the status of this category?" %}
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
          <button type="submit" class="btn btn-primary">{% trans "Update" %}</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Visibility Toggle Modal
<div class="modal fade" id="visibilityToggleModal" tabindex="-1" aria-labelledby="visibilityToggleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="visibilityToggleForm" method="POST" action="">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="visibilityToggleModalLabel">{% trans "Toggle Visibility" %}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{% trans 'Close' %}"></button>
        </div>
        <div class="modal-body">
          {% trans "Are you sure you want to update the visibility of this category?" %}
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
          <button type="submit" class="btn btn-primary">{% trans "Confirm" %}</button>
        </div>
      </form>
    </div>
  </div>
</div> -->

<!-- Add Department Modal -->
<div class="modal fade" id="addDepartmentModal" tabindex="-1" aria-labelledby="addDepartmentModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addDepartmentModalLabel">{% trans "Add Department" %}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="addDepartmentForm" action="{% url 'departments:create' %}" method="POST">
          {% csrf_token %}
          <div class="mb-3">
            <label for="departmentName" class="form-label">{% trans "Department Name" %}</label>
            <input type="text" class="form-control" id="departmentName" name="name" required>
          </div>
          <button type="submit" class="btn btn-primary">{% trans "Save" %}</button>
        </form>
        <div id="message" class="mt-3"></div>
      </div>
    </div>
  </div>
</div>

<!-- Edit Department Modal -->
<div class="modal fade" id="editDepartmentModal" tabindex="-1" aria-labelledby="editDepartmentModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editDepartmentModalLabel">{% trans "Edit Department" %}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="editDepartmentForm" action="{% url 'departments:user.create' %}" method="POST">
          {% csrf_token %}
          <input type="hidden" id="editDepartmentId" name="id">
          <div class="mb-3">
            <label for="editDepartmentName" class="form-label">{% trans "Department Name" %}</label>
            <input type="text" class="form-control" id="editDepartmentName" name="name" required>
          </div>
          <button type="submit" class="btn btn-primary">{% trans "Save Changes" %}</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Delete Department Modal -->
<div class="modal fade" id="deleteConfirmationModal" tabindex="-1" aria-labelledby="deleteConfirmationModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="deleteForm" method="POST">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="deleteConfirmationModalLabel">{% trans "Confirm Delete" %}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{% trans 'Close' %}"></button>
        </div>
        <div class="modal-body">
          {% trans "Are you sure you want to delete this item? This action cannot be undone." %}
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
          <button type="submit" class="btn btn-danger">{% trans "Delete" %}</button>
        </div>
      </form>
    </div>
  </div>
</div>




<script>
  document.addEventListener('DOMContentLoaded', function () {
    const checkboxes = document.querySelectorAll('.department-checkbox');
    const editButton = document.getElementById('editDepartmentBtn');
    const deleteBtn = document.getElementById('deleteDepartmentBtn');
    const editDepartmentId = document.getElementById('editDepartmentId');
    const editDepartmentName = document.getElementById('editDepartmentName');
    const deleteForm = document.getElementById('deleteForm');

    function updateButtons() {
      const checked = Array.from(checkboxes).filter(cb => cb.checked);

      if (checked.length === 1) {
        const selected = checked[0];
        editButton.disabled = false;
        deleteBtn.disabled = false;

        const label = document.querySelector(`label[for="${selected.id}"]`);

        // Set the edit form values
        editDepartmentId.value = selected.value;
        editDepartmentName.value = label?.innerText || '';

        // Set the delete form action
        const deleteUrl = `{% url 'departments:user.delete' '000' %}`.replace('000', selected.value);
        deleteForm.action = deleteUrl;
      } else {
        editButton.disabled = true;
        deleteBtn.disabled = true;
      }
    }

    checkboxes.forEach(cb => {
      cb.addEventListener('change', updateButtons);
    });

    updateButtons(); // Initial state
  });
</script>

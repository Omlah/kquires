{% extends "base.html" %}
{% load i18n static %}

{% block title %}{% trans 'File Manager' %}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-folder-open"></i> {% trans 'File Manager' %}
                    </h3>
                </div>
                <div class="card-body">
                    <!-- Upload Section -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card border-primary">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0">
                                        <i class="fas fa-cloud-upload-alt"></i> Upload PDF Files
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <!-- File Selection -->
                                    <div class="mb-3">
                                        <label for="pdfFileInput" class="form-label">Choose PDF Files:</label>
                                        <input type="file" id="pdfFileInput" accept=".pdf" multiple class="form-control">
                                    </div>
                                    
                                    <!-- Upload Button -->
                                    <button type="button" class="btn btn-success btn-lg w-100" id="uploadBtn">
                                        <i class="fas fa-cloud-upload-alt"></i> Save & Upload to Google Drive
                                    </button>
                                    
                                    <!-- Status Display -->
                                    <div id="uploadStatus" class="mt-3" style="display: none;">
                                        <div class="alert alert-info">
                                            <div id="statusText">Preparing upload...</div>
                                            <div class="progress mt-2">
                                                <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Instructions -->
                                    <div class="alert alert-light mt-3">
                                        <small>
                                            <i class="fas fa-info-circle"></i>
                                            <strong>How to upload:</strong><br>
                                            1. Click "Choose Files" above and select PDF files<br>
                                            2. Click "Save & Upload to Google Drive" button<br>
                                            3. Files will be uploaded to Google Drive and text extracted automatically
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Search Section -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-search"></i>
                                </span>
                                <input type="text" id="searchInput" class="form-control" placeholder="Search files...">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <select id="filterType" class="form-select">
                                <option value="all">All Files</option>
                                <option value="pdf">PDF Files</option>
                                <option value="article">Article Files</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <button type="button" class="btn btn-outline-secondary w-100" id="clearSearchBtn">
                                <i class="fas fa-times"></i> Clear
                            </button>
                        </div>
                    </div>

                    <!-- Files Table -->
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>{% trans 'Type' %}</th>
                                    <th>{% trans 'Filename' %}</th>
                                    <th>{% trans 'Size' %}</th>
                                    <th>{% trans 'Upload Date' %}</th>
                                    <th>{% trans 'Status' %}</th>
                                    <th>{% trans 'Actions' %}</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- PDF Files -->
                                {% for pdf_file in pdf_files %}
                                <tr class="file-row" data-file-type="pdf">
                                    <td>
                                        <span class="badge bg-danger">
                                            <i class="fas fa-file-pdf"></i> PDF
                                        </span>
                                    </td>
                                    <td class="file-name">{{ pdf_file.original_filename }}</td>
                                    <td>{{ pdf_file.get_file_size_display }}</td>
                                    <td>{{ pdf_file.upload_date|date:"M d, Y H:i" }}</td>
                                    <td>
                                        <span class="badge bg-{% if pdf_file.status == 'ready' %}success{% elif pdf_file.status == 'error' %}danger{% else %}warning{% endif %}">
                                            {{ pdf_file.get_status_display }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if pdf_file.extracted_text %}
                                        <button type="button" class="btn btn-sm btn-info" onclick="showExtractedText('{{ pdf_file.extracted_text|escapejs }}', '{{ pdf_file.original_filename }}')">
                                            <i class="fas fa-eye"></i> View Text
                                        </button>
                                        {% endif %}
                                         <!-- <button type="button" class="btn btn-sm btn-danger" onclick="deletePDFFile({{ pdf_file.id }}, '{{ pdf_file.original_filename }}')">
                                            <i class="fas fa-trash"></i> Delete
                                        </button> -->
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center text-muted">
                                        <i class="fas fa-file-pdf fa-2x mb-2"></i><br>
                                        No PDF files uploaded yet
                                    </td>
                                </tr>
                                {% endfor %}

                                <!-- Article Files -->
                                {% for article in articles %}
                                <tr class="file-row" data-file-type="article">
                                    <td>
                                        <span class="badge bg-primary">
                                            <i class="fas fa-file-alt"></i> Article
                                        </span>
                                    </td>
                                    <td class="file-name">{{ article.title }}</td>
                                    <td>{{ article.get_file_size_display }}</td>
                                    <td>{{ article.created_at|date:"M d, Y H:i" }}</td>
                                    <td>
                                        <span class="badge bg-success">Ready</span>
                                    </td>
                                    <td>
                                        <!-- <button type="button" class="btn btn-sm btn-info" onclick="showFileInfo({{ article.id }})">
                                            <i class="fas fa-info-circle"></i> Info
                                        </button> -->
                                        <!-- <button type="button" class="btn btn-sm btn-danger" onclick="deleteFile({{ article.id }}, '{{ article.title }}')">
                                            <i class="fas fa-trash"></i> Delete
                                        </button> -->
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Statistics -->
                    <div class="row mt-4">
                        <div class="col-md-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body text-center">
                                    <h4>{{ total_files }}</h4>
                                    <small>Total Files</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success text-white">
                                <div class="card-body text-center">
                                    <h4>{{ total_pdf_files }}</h4>
                                    <small>PDF Files</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-info text-white">
                                <div class="card-body text-center">
                                    <h4>{{ total_article_files }}</h4>
                                    <small>Article Files</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning text-white">
                                <div class="card-body text-center">
                                    <h4>{{ total_size_mb }} MB</h4>
                                    <small>Total Size</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
<div class="modal fade" id="extractedTextModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Extracted Text</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Text content will be inserted here -->
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="fileInfoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">File Information</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- File info will be inserted here -->
            </div>
        </div>
    </div>
</div>

{% csrf_token %}
{% endblock %}

{% block extra_js %}
<script>
// Simple upload handler
function handleUploadClick() {
    console.log('handleUploadClick function called!');
    const fileInput = document.getElementById('pdfFileInput');
    
    if (!fileInput.files || fileInput.files.length === 0) {
        alert('Please select PDF files first!\n\n1. Click "Choose Files" above\n2. Select PDF files from your computer\n3. Then click "Save & Upload to Google Drive"');
        return;
    }
    
    // Show upload status
    const uploadStatus = document.getElementById('uploadStatus');
    const statusText = document.getElementById('statusText');
    const progressBar = document.getElementById('progressBar');
    
    if (uploadStatus) uploadStatus.style.display = 'block';
    if (statusText) statusText.textContent = `Uploading ${fileInput.files.length} file(s)...`;
    if (progressBar) progressBar.style.width = '0%';
    
    // Upload each file
    const files = Array.from(fileInput.files);
    let completedFiles = 0;
    
    files.forEach((file, index) => {
        uploadSingleFile(file, index + 1, files.length);
    });
    
    function uploadSingleFile(file, currentIndex, totalFiles) {
        const formData = new FormData();
        formData.append('pdf_file', file);
        
        // Add CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfToken) {
            formData.append('csrfmiddlewaretoken', csrfToken.value);
        }
        
        fetch('/articles/upload-pdf/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrfToken ? csrfToken.value : ''
            }
        })
        .then(response => response.json())
        .then(data => {
            completedFiles++;
            const progress = Math.round((completedFiles / totalFiles) * 100);
            if (progressBar) progressBar.style.width = progress + '%';
            
            if (data.success) {
                if (statusText) {
                    statusText.innerHTML = `✅ File ${currentIndex}/${totalFiles}: ${file.name}<br>✓ Uploaded successfully`;
                }
                alert(`✅ File ${currentIndex}/${totalFiles}: "${file.name}" uploaded successfully!`);
            } else {
                if (statusText) {
                    statusText.innerHTML = `❌ File ${currentIndex}/${totalFiles}: ${file.name}<br>Error: ${data.message}`;
                }
                alert(`❌ File ${currentIndex}/${totalFiles}: "${file.name}" failed - ${data.message}`);
            }
            
            // If all files completed
            if (completedFiles === totalFiles) {
                setTimeout(() => {
                    alert(`Upload completed!\n\n${completedFiles}/${totalFiles} files processed successfully.`);
                    window.location.reload();
                }, 2000);
            }
        })
        .catch(error => {
            console.error('Upload error:', error);
            completedFiles++;
            if (statusText) {
                statusText.innerHTML = `❌ Error uploading ${file.name}: ${error.message}`;
            }
            alert(`❌ Error uploading "${file.name}": ${error.message}`);
            
            if (completedFiles === totalFiles) {
                alert('Upload completed with some errors. Check the status above.');
            }
        });
    }
}

// Test functions
function testUpload() {
    const fileInput = document.getElementById('pdfFileInput');
    if (fileInput.files && fileInput.files.length > 0) {
        alert(`Test: Found ${fileInput.files.length} files selected.`);
    } else {
        alert('Test: No files selected. Please select files first.');
    }
}

function testButtonClick() {
    alert('Button click test works! JavaScript is functioning.');
}

function testUploadEndpoint() {
    fetch('/articles/upload-pdf/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({test: 'data'})
    })
    .then(response => response.text())
    .then(text => {
        alert(`Upload endpoint test: Status ${response.status}\nResponse: ${text.substring(0, 100)}`);
    })
    .catch(error => {
        alert(`Upload endpoint failed: ${error.message}`);
    });
}

function showExtractedText(text, fileName) {
    const modalElement = document.getElementById('extractedTextModal');
    const modalTitle = modalElement.querySelector('.modal-title');
    const modalBody = modalElement.querySelector('.modal-body');
    
    modalTitle.textContent = `Extracted Text: ${fileName}`;
    modalBody.innerHTML = `<pre style="white-space: pre-wrap; max-height: 400px; overflow-y: auto;">${text}</pre>`;
    
    const modal = new bootstrap.Modal(modalElement);
    modal.show();
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    console.log('File manager JavaScript loaded');
    
    const fileInput = document.getElementById('pdfFileInput');
    const uploadBtn = document.getElementById('uploadBtn');
    const testUploadBtn = document.getElementById('testUploadBtn');
    const testButtonClickBtn = document.getElementById('testButtonClickBtn');
    const testUploadEndpointBtn = document.getElementById('testUploadEndpointBtn');
    const clearSearchBtn = document.getElementById('clearSearchBtn');
    
    console.log('Upload button found:', uploadBtn);
    
    if (!fileInput || !uploadBtn) {
        console.error('Required elements not found');
        return;
    }
    
    // File selection handler
    fileInput.addEventListener('change', function() {
        const files = this.files;
        if (files.length > 0) {
            uploadBtn.innerHTML = `<i class="fas fa-cloud-upload-alt"></i> Upload ${files.length} File(s) to Google Drive`;
            uploadBtn.classList.remove('btn-secondary');
            uploadBtn.classList.add('btn-success');
        } else {
            uploadBtn.innerHTML = `<i class="fas fa-cloud-upload-alt"></i> Save & Upload to Google Drive`;
            uploadBtn.classList.remove('btn-success');
            uploadBtn.classList.add('btn-secondary');
        }
    });
    
    // Button click handlers
    uploadBtn.addEventListener('click', function() {
        console.log('Upload button clicked!');
        handleUploadClick();
    });
    
    if (testUploadBtn) {
        testUploadBtn.addEventListener('click', testUpload);
    }
    if (testButtonClickBtn) {
        testButtonClickBtn.addEventListener('click', testButtonClick);
    }
    if (testUploadEndpointBtn) {
        testUploadEndpointBtn.addEventListener('click', testUploadEndpoint);
    }
    if (clearSearchBtn) {
        clearSearchBtn.addEventListener('click', function() {
            document.getElementById('searchInput').value = '';
            document.getElementById('filterType').value = 'all';
            const fileRows = document.querySelectorAll('.file-row');
            fileRows.forEach(row => {
                row.style.display = '';
            });
        });
    }
    
    console.log('All event listeners set up successfully');
});
</script>
{% endblock %}
{% extends "base.html" %}
{% load i18n %}
{% load article_filters %}
{% block title %}
      kquires | {% trans 'Article'%}
{% endblock title %}
{% block content %}
{% include "pages/layout/navbar.html" %}
{% load static %}
{% load custom_filters %}

<style>
    .content-header {
        border-bottom: 2px solid #ddd;
        padding-bottom: 10px;
        margin-bottom: 20px;
    }
    .sidebar {
        background-color: #f1f5f9;
        padding: 15px;
        border-radius: 10px;
    }
    .sidebar h6 {
        font-weight: bold;
    }
    .sidebar ul {
        list-style: none;
        padding: 0;
    }
    .sidebar ul li {
        margin-bottom: 10px;
    }
    .sidebar ul li a {
        text-decoration: none;
        color: #333;
    }
    .sidebar ul li a:hover {
        text-decoration: underline;
    }
    .content-body .uploaded-image{
        margin: 25px;
        margin-left: 50px;
        border-bottom: 1px solid rgb(211, 208, 208);
    }
    .content-body p{
        margin-left: 10px;
    }
    .content-body img {
        max-width: 100%;
        height: auto;
        border-radius: 5px;
    }
    .content-body .carousel-control-next {
        top:30%;
        width: 42px;
        height: 42px;
        background-image: url("{% static 'images/right_arrow.svg' %}") !important;
        background-repeat: no-repeat !important;
        background-position: center !important;
        background-size: contain !important;
    }
    .content-body .carousel-control-prev{
        top:30%;
        width: 42px;
        height: 42px;
        background-image: url("{% static 'images/left_arrow.svg' %}") !important;
        background-repeat: no-repeat !important;
        background-position: center !important;
        background-size: contain !important;
    }
    .content-body .carousel-control-prev-icon {
        background-image: url("{% static 'images/left_arrow.svg' %}") !important;
    }
    .content-body .carousel-control-next-icon {
        background-image: url('/static/images/right_arrow.svg');
    }
    .content-body .carousel-inner img {
        width: 110%;
        height: 500px;
        object-fit: contain;
        border-radius: 5px;
    }
    .sidebar-headings > li {
      margin-bottom: 0 !important;
    }
    .sidebar-link > p {
      font-size:17px;
      margin-bottom: 0;
    }
    .sidebar-link.active {
      font-weight: bold;
      color: #A94BEA;
    }
    html {
      scroll-behavior: smooth;
    }
</style>

<div class="container my-5">
    <div class="content-header bg-white p-3 rounded shadow-sm">
        <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex justify-content-start align-items-center text-muted">
                <!-- First Item: Article Details -->
                <div class="d-flex align-items-center me-4">
                    <span>{% trans "Articles Details:" %}</span>
                </div>

                <!-- Second Item: Article Title -->
                <div class="d-flex align-items-center me-4">
                    <img src="{% static 'images/userming.svg' %}" alt="{% trans 'User Icon' %}" class="ms-2" style="margin-right: 5px;" >
                    <span id="article-title">{{ article_title }}</span>
                </div>

                <!-- Third Item: User -->
                <div class="d-flex align-items-center me-4">
                    <img src="{% static 'images/userming.svg' %}" alt="{% trans 'User Icon' %}" class="ms-2" style="margin-right: 5px;" >
                    <span>{{ article.user.name }}</span>
                </div>
            </div>

            <!-- Language Switcher -->
            <div class="d-flex align-items-center">
                <span class="me-2">{% trans "Language:" %}</span>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="switchLanguage('{{ article.language }}')" id="current-lang-btn">
                        {% if article.language == 'english' %}🇺🇸 English{% else %}🇸🇦 العربية{% endif %}
                    </button>
                    {% if article.get_translations %}
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="switchLanguage('{{ article.get_translations.0.language }}')" id="other-lang-btn">
                        {% if article.language == 'english' %}🇸🇦 العربية{% else %}🇺🇸 English{% endif %}
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-4 col-lg-3 border-dark border-end">
            <div style="position: sticky; top: 20px; z-index: 999;">
                <div class="sidebar mb-4" style="background-color: #D9E8F1;">
                    <h6 class="d-flex align-items-center">
                        <img src="{% static 'images/sec1.svg' %}" alt="{% trans 'Logo' %}" style="width: 20px; height: 20px; margin-right: 8px;">
                        {% trans "On This Page" %}
                    </h6>
                    <ul id="sidebar-headings">
                        {% for heading in article.brief_description|extract_h1 %}
                            <li>
                                <a href="#heading-{{ forloop.counter }}" class="sidebar-link" data-target="heading-{{ forloop.counter }}">
                                    {{ heading|safe }}
                                </a>
                            </li>
                        {% endfor %}
                    </ul>
                </div>

                <div class="sidebar" style="background-color: #F1DCDC;">
                    <h6 class="d-flex align-items-center mb-3">
                        <img src="{% static 'images/sec2.svg' %}" alt="{% trans 'Logo' %}" style="width: 20px; height: 20px; margin-right: 8px;">
                        {% trans "Related Articles" %}
                    </h6>
                    <ul>
                        {% for related_article in related_articles %}
                            <li><a href="{% url 'article_detail' related_article.id %}">{{ related_article.title }}</a></li>
                        {% empty %}
                            <li>{% trans "No related articles found" %}</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>

        <!-- Content -->
        <div class="col-md-8 col-lg-9">
            <div class="content-body" id="article-content">
                {{ article_brief_description|safe }}
            </div>
            
            <!-- Google Drive File Section -->
            {% if article.google_drive_file_id %}
            <div class="mt-4 p-3 bg-light rounded">
                <h6 class="d-flex align-items-center mb-3">
                    <i class="fab fa-google-drive text-primary me-2"></i>
                    {% trans "Attached File" %}
                </h6>
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <p class="mb-1"><strong>{{ article.google_drive_filename }}</strong></p>
                        {% if article.google_drive_file_size %}
                        <small class="text-muted">{{ article.google_drive_file_size|filesizeformat }}</small>
                        {% endif %}
                    </div>
                    <div class="d-flex gap-2">
                        {% if article.google_drive_web_view_link %}
                        <a href="{{ article.google_drive_web_view_link }}" target="_blank" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-external-link-alt"></i> {% trans "View" %}
                        </a>
                        {% endif %}
                        {% if article.google_drive_web_content_link %}
                        <a href="{{ article.google_drive_web_content_link }}" target="_blank" class="btn btn-primary btn-sm">
                            <i class="fas fa-download"></i> {% trans "Download" %}
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
            
            <div class="mt-3">
                <button type="button" class="btn btn-primary" id="copy-url-btn">
                    {% trans "Copy Link" %}
                </button>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#smsModal">
                    {% trans "Share By SMS" %}
                </button>
            </div>
        </div>
    </div>
</div>

<!-- SMS Modal -->
<div class="modal fade" id="smsModal" tabindex="-1" aria-labelledby="smsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="smsModalLabel">{% trans "Share By SMS" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="smsForm">
                    <div class="mb-3">
                        <label for="phoneNumber" class="form-label">{% trans "Phone Number" %}</label>
                        <input type="text" class="form-control" id="phoneNumber" placeholder="{% trans 'Enter phone number' %}">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Close" %}</button>
                <button type="button" class="btn btn-primary" id="sendSmsBtn">{% trans "Send SMS" %}</button>
            </div>
        </div>
    </div>
</div>

<script>
  document.getElementById("copy-url-btn").addEventListener("click", function () {
      const currentURL = window.location.href;
      navigator.clipboard.writeText(currentURL).then(() => {
          alert("✅ {% trans 'Link copied to clipboard!' %}");
      }).catch(err => {
          console.error("Failed to copy URL:", err);
          alert("❌ {% trans 'Failed to copy link. Try again!' %}");
      });
  });

  document.getElementById("sendSmsBtn").addEventListener("click", function () {
      const phoneNumber = document.getElementById("phoneNumber").value;
      const currentURL = window.location.href;
      if (phoneNumber) {
          alert(`SMS sent to ${phoneNumber} with the link: ${currentURL}`);
          const smsModal = new bootstrap.Modal(document.getElementById('smsModal'));
          smsModal.hide();
      } else {
          alert("{% trans 'Please enter a phone number.' %}");
      }
  });

  document.addEventListener("DOMContentLoaded", function () {
    const headings = document.querySelectorAll(".content-body h1, .content-body h2, .content-body h3, .content-body h4, .content-body h5, .content-body h6");
    const sidebarLinks = document.querySelectorAll(".sidebar-link");

    sidebarLinks.forEach((link, index) => {
        link.addEventListener("click", function (e) {
            e.preventDefault();
            const targetHeading = headings[index];
            if (targetHeading) {
                targetHeading.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        });
    });

    function highlightCurrentHeading() {
        let index = -1;
        headings.forEach((heading, i) => {
            const rect = heading.getBoundingClientRect();
            if (rect.top >= 0 && rect.top < window.innerHeight / 2) {
                index = i;
            }
        });
        if (window.scrollY + window.innerHeight >= document.body.scrollHeight - 5) {
            index = headings.length - 1;
        }
        sidebarLinks.forEach((link) => link.classList.remove("active"));
        if (index !== -1) {
            sidebarLinks[index].classList.add("active");
        }
    }

    window.addEventListener("scroll", highlightCurrentHeading);
    highlightCurrentHeading();

    // Language switching
    window.switchLanguage = function (language) {
        document.cookie = `language=${language === 'arabic' ? 'ar' : 'en'}; path=/`;
        window.location.reload();
    }
  });
</script>
{% endblock content %}

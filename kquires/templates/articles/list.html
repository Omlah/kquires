{% extends 'pages/layout/sidebar.html' %}
{% load static %}
{% load i18n %}
{% block title %}
  kquires |{% trans 'Articles List' %}
{% endblock %}
{% block content %}
  <style>
    .form-section {
      background-color: #fff;
      padding: 20px;
      border-radius: 10px;
    }
    .profile-card {
      text-align: center;
      background-color: #fff;
      padding: 20px;

      border-radius: 10px;
    }
    .profile-card img {
      border-radius: 50%;
      max-width: 150px;
      margin-bottom: 10px;
    }
    .custom-table {
      border-radius: 8px;

      overflow: hidden;
    }
    .custom-table thead {
      background-color: #f1f5f9;
    }
    .custom-table tbody tr {
      background-color: #ffffff;
    }
    .custom-table tbody tr:nth-child(even) {
      background-color: #f8f9fa;
    }
    .new-ticket-btn {
      margin-top: 10px;
    }
    .header-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background-color: #f8f9fa; /* Background color */
      padding: 10px;
      /* Border for layout visibility */
    }

    .btn-new {
      background-color: #007bff; /* Blue background */
      color: white;
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
    }

    .btn-new:hover {
      background-color: #0056b3; /* Darker blue on hover */
    }

    .search-bar input {
      width: 300px;
      padding: 8px;

      border-radius: 4px;
    }

    .btn-categories {
      background-color: #f1f1f1;
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
    }
  </style>
  <div class="d-flex align-items-center justify-content-between bg-light p-2">
    <div class="text-center" style="font-size: 20px; color:black; font-weight: bold; cursor: pointer;">
      {% trans 'Articles' %}
    </div>

    <div class="search-bar mx-auto" style="width: 300px; position: relative;">
      <form id="search-form" hx-get="{% url 'articles:list' %}" hx-target="#articles-table" hx-trigger="keyup changed delay:300ms">
          <input 
              type="text" 
              id="article-search" 
              class="form-control form-control-sm" 
              placeholder="{% trans 'Search Articles' %}" 
              name="q"
              {% if LANGUAGE_CODE == 'ar' %}
                  dir="rtl"
                  style="padding-right: 10px; text-align: right;"
              {% else %}
                  dir="ltr"
                  style="padding-left: 10px; text-align: left;"
              {% endif %}
          />
      </form>
  
      {% if LANGUAGE_CODE == 'ar' %}
          <!-- Icon on the left for Arabic (RTL) -->
          <img src="{% static 'images/searchb.svg' %}" alt="{% trans 'Search Icon' %}"
              class="position-absolute top-50 start-0 translate-middle-y"
              style="width: 20px; height: 20px;">
      {% else %}
          <!-- Icon on the right for LTR -->
          <img src="{% static 'images/searchb.svg' %}" alt="{% trans 'Search Icon' %}"
              class="position-absolute top-50 end-0 translate-middle-y"
              style="width: 20px; height: 20px;">
      {% endif %}
  </div>
    <button type="button" class="btn btn-primary new-article-btn" data-bs-toggle="modal" data-bs-target="#newArticleModal">+{% trans 'New Article' %}</button>
    <a href="{% url 'articles:export_activity_log_excel' %}"><img src="{% static 'images/export.svg' %}" alt="{% trans 'Section Icon' %}" class="ms-2" /></a>
  </div>

  <!-- Container to align table with the above div -->
  <div class="container-fluid mt-3">
    <div class="form-section">
      <div id="articles-table">
        {% include 'articles/partials/table.html' %}
      </div>
    </div>
  </div>

  {% include 'articles/partials/form.html' %}

  <script>
    document.getElementById('newArticleModal').addEventListener('hide.bs.modal', function () {
      document.getElementById('id').value = ''
      document.getElementById('title').value = ''
      document.getElementById('category').value = ''
      document.getElementById('short_description').value = ''
      CKEDITOR.instances['brief_description'].setData('')
    })

    window.currentArticleId = null; // Store current article ID for language switching
    window.mainArticleId = null; // Store main article ID for language switching
    window.currentLanguage = 'english'; // Store current language being edited

    window.fetchArticleDetails = function(articleId, language = 'english') {
      window.currentArticleId = articleId; // Store for language switching
      window.currentLanguage = language; // Store current language
      
      fetch(`{% url 'articles:article_detail_api' '000' %}`.replace('000', articleId) + `?language=${language}`)
        .then((response) => response.json())
        .then((data) => {
          console.log('Fetched Article Data:', data)

          document.getElementById('id').value = data.id
          document.getElementById('title').value = data.title
          document.getElementById('short_description').value = data.short_description
          document.getElementById('current_language').value = data.current_language
          
          // Store both IDs for proper language switching
          window.currentArticleId = data.id
          window.mainArticleId = data.main_id

          // Ensure CKEditor is ready before inserting content
          if (CKEDITOR.instances.brief_description) {
            CKEDITOR.instances.brief_description.destroy() // Reset CKEditor to avoid conflicts
          }

          CKEDITOR.replace('brief_description', {
            height: 300,
            allowedContent: true, // Allow all HTML content, including images
            extraAllowedContent: 'img[*]{*}; p[*]{*}; figure[*]{*}; figcaption[*]{*};'
          })

          // Wait for CKEditor to fully initialize before inserting content
          setTimeout(() => {
            CKEDITOR.instances.brief_description.setData(data.brief_description)
            console.log('Inserted Data into CKEditor:', data.brief_description)
          }, 500)

          // âœ… Set category dropdown value
          const categorySelect = document.getElementById('category')
          const options = categorySelect.options
          for (let i = 0; i < options.length; i++) {
            if (options[i].text === data.category || options[i].value === data.category) {
              categorySelect.selectedIndex = i
              break
            }
          }

          // Show language switcher and update button states
          const languageSwitcher = document.getElementById('languageSwitcher');
          console.log('ðŸ” Language switcher element:', languageSwitcher);
          console.log('ðŸ” Data received:', data);
          
          if (languageSwitcher) {
            languageSwitcher.style.display = 'block';
            console.log('âœ… Language switcher shown');
            
            // Update dropdown button text based on current language
            const languageDropdown = document.getElementById('languageDropdown');
            if (languageDropdown) {
              if (data.current_language === 'english') {
                languageDropdown.innerHTML = 'ðŸ‡ºðŸ‡¸ English';
              } else {
                languageDropdown.innerHTML = 'ðŸ‡¸ðŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©';
              }
            }
            
            // Update dropdown item states based on available languages
            const viewEnglish = document.getElementById('viewEnglish');
            const viewArabic = document.getElementById('viewArabic');
            
            console.log('ðŸ” English button:', viewEnglish);
            console.log('ðŸ” Arabic button:', viewArabic);
            console.log('ðŸ” Has English:', data.has_english);
            console.log('ðŸ” Has Arabic:', data.has_arabic);
            
            if (viewEnglish && viewArabic) {
              // Update dropdown items
              if (!data.has_arabic) {
                viewArabic.innerHTML = 'ðŸ‡¸ðŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© +';
                viewArabic.title = '{% trans "Create Arabic translation" %}';
              } else {
                viewArabic.innerHTML = 'ðŸ‡¸ðŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©';
                viewArabic.title = '{% trans "View in Arabic" %}';
              }
              
              viewEnglish.innerHTML = 'ðŸ‡ºðŸ‡¸ English';
              viewEnglish.title = '{% trans "View in English" %}';
              
              console.log('âœ… Dropdown states updated');
            } else {
              console.log('âŒ Dropdown items not found');
            }
          } else {
            console.log('âŒ Language switcher not found');
          }

          // Update modal title to indicate viewing mode
          const modalTitle = document.getElementById('newArticleModalLabel');
          if (modalTitle) {
            modalTitle.innerHTML = `{% trans 'View Article' %} <small class="text-muted">(${data.current_language})</small>`;
          }

          var modal = new bootstrap.Modal(document.getElementById('newArticleModal'))
          modal.show()
        })
        .catch((error) => console.error('Error fetching article details:', error))
    }


    function setDeleteFormAction(targetId) {
      const deleteForm = document.getElementById('deleteForm')
      const deleteUrl = `{% url 'articles:delete' '000' %}`.replace('000', targetId) // Update the path to match your URL configuration
      deleteForm.action = deleteUrl
    }

    function setStatusModalData(targetId, status) {
      const form = document.getElementById('statusUpdateForm')
      const actionUrl = `{% url 'articles:status' '000' %}`.replace('000', targetId)
      form.action = actionUrl

      // Add status as a hidden input in the form
      let statusInput = form.querySelector('input[name="status"]')
      if (!statusInput) {
        statusInput = document.createElement('input')
        statusInput.type = 'hidden'
        statusInput.name = 'status'
        form.appendChild(statusInput)
      }
      statusInput.value = status
    }

    function setVisibilityModalData(targetId, visibility) {
      const form = document.getElementById('visibilityToggleForm')
      const actionUrl = `{% url 'articles:visibility' '000' %}`.replace('000', targetId)
      form.action = actionUrl

      // Add visibility as a hidden input in the form
      let visibilityInput = form.querySelector('input[name="visibility"]')
      if (!visibilityInput) {
        visibilityInput = document.createElement('input')
        visibilityInput.type = 'hidden'
        visibilityInput.name = 'visibility'
        form.appendChild(visibilityInput)
      }
      visibilityInput.value = visibility
    }

    document.addEventListener('DOMContentLoaded', function () {
      const dropzone = document.getElementById('file-dropzone')
      const fileInput = document.getElementById('file_input')

      dropzone.addEventListener('dragover', (event) => {
        event.preventDefault()
        dropzone.classList.add('dragover')
      })

      dropzone.addEventListener('dragleave', () => {
        dropzone.classList.remove('dragover')
      })

      dropzone.addEventListener('drop', async (event) => {
        event.preventDefault()
        dropzone.classList.remove('dragover')

        const files = event.dataTransfer.files
        await handleFiles(files)
      })

      fileInput.addEventListener('change', async () => {
        const files = fileInput.files
        await handleFiles(files)
      })

      async function handleFiles(files) {
        const loader = document.getElementById('loader')
        if (files.length > 0) {
          loader.style.display = 'block'
          for (let i = 0; i < files.length; i++) {
            const file = files[i]
            const formData = new FormData()
            formData.append('file', file)

            try {
              // 1ï¸âƒ£ **Upload Image to Server**
              const response = await fetch('/articles/process_file/', {
                method: 'POST',
                body: formData
              })

              if (!response.ok) {
                console.error('File upload failed.')
                return
              }

              const data = await response.json()
              console.log('Server Response:', data)
              if (data.image_url && /\.(jpeg|jpg|png|gif|webp)$/i.test(data.image_url)) {
                // 2ï¸âƒ£ **Read Image from Server and Preview in CKEditor**
                console.log('Uploaded Image URL:', data.image_url)

                const BASE_URL = window.location.origin
                const imageURL = data.image_url.startsWith('http') ? data.image_url : BASE_URL + data.image_url
                console.log('Final Image URL:', imageURL)

                // **Create an <img> element**
                const img = document.createElement('img')
                img.alt = 'Uploaded Image'
                img.classList.add('d-block')
                img.style = 'max-width: 100%; max-height: 300px;'

                // **Use FileReader to load the backend image**
                const backendImage = new Image()
                backendImage.crossOrigin = 'anonymous' // **Prevents CORS issues**
                backendImage.src = imageURL

                backendImage.onload = function () {
                  console.log('Image successfully loaded from backend:', imageURL)
                  img.src = backendImage.src

                  const imgWrapper = document.createElement('div')
                  imgWrapper.classList.add('uploaded-image')
                  imgWrapper.appendChild(img)

                  // **Insert into CKEditor**
                  setTimeout(() => {
                    let element = CKEDITOR.dom.element.createFromHtml(imgWrapper.outerHTML)
                    CKEDITOR.instances.brief_description.insertElement(element)
                    console.log('Final Image inserted into CKEditor:', img.src)
                  }, 300)
                }

                backendImage.onerror = function () {
                  console.error('Failed to load image from backend:', imageURL)
                }
              } else if (data.video_url && /\.(mp4|webm|ogg)$/i.test(data.video_url)) {
                console.log('Uploaded Video URL:', data.video_url)

                const BASE_URL = window.location.origin
                const videoURL = data.video_url.startsWith('http') ? data.video_url : BASE_URL + data.video_url

                // **Create a <video> element**
                const video = document.createElement('video')
                video.src = videoURL
                video.controls = true // Enable play/pause controls
                video.classList.add('d-block', 'w-100')
                video.style = 'max-width: 100%; max-height: 400px;'

                const videoWrapper = document.createElement('div')
                videoWrapper.classList.add('uploaded-video')
                videoWrapper.appendChild(video)

                // **Insert into CKEditor**
                setTimeout(() => {
                  let element = CKEDITOR.dom.element.createFromHtml(videoWrapper.outerHTML)
                  CKEDITOR.instances.brief_description.insertElement(element)
                  console.log('Final Video inserted into CKEditor:', video.src)
                }, 300)
              } else if (data.content) {
                console.log('Uploaded Text Content:', data.content)

                CKEDITOR.instances.brief_description.insertHtml(`<p><strong>Extracted Content:</strong> </p><p>${data.content.replace(/\n/g, '<br>')}</p>`)
              } else {
                console.warn('No image URL returned from server.')
              }
            } catch (error) {
              console.error('Error uploading file:', error)
            }
          }
          loader.style.display = 'none'
        } else {
          alert('Please upload at least one file.')
        }
      }
    })
  </script>
{% endblock %}

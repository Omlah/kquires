{% extends 'pages/layout/sidebar.html' %}
{% load static %}
{% load i18n %}
{% block title %}
  kquires |{% trans 'Articles List' %}
{% endblock %}
{% block content %}
  <style>
    .form-section {
      background-color: #fff;
      padding: 20px;
      border-radius: 10px;
    }
    .profile-card {
      text-align: center;
      background-color: #fff;
      padding: 20px;
      border-radius: 10px;
    }
    .profile-card img {
      border-radius: 50%;
      max-width: 150px;
      margin-bottom: 10px;
    }
    .custom-table {
      border-radius: 8px;
      overflow: hidden;
    }
    .custom-table thead {
      background-color: #f1f5f9;
    }
    .custom-table tbody tr {
      background-color: #ffffff;
    }
    .custom-table tbody tr:nth-child(even) {
      background-color: #f8f9fa;
    }
    .new-ticket-btn {
      margin-top: 10px;
    }
    .header-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background-color: #f8f9fa;
      padding: 10px;
    }
    .btn-new {
      background-color: #007bff;
      color: white;
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
    }
    .btn-new:hover {
      background-color: #0056b3;
    }
    .search-bar input {
      width: 300px;
      padding: 8px;
      border-radius: 4px;
    }
    .btn-categories {
      background-color: #f1f1f1;
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
    }
  </style>

  <div class="d-flex align-items-center justify-content-between bg-light p-2">
    <div class="text-center" style="font-size: 20px; color:black; font-weight: bold; cursor: pointer;">
      {% trans 'Articles' %}
    </div>

    <div class="search-bar mx-auto" style="width: 300px; position: relative;">
      <form id="search-form" hx-get="{% url 'articles:list' %}" hx-target="#articles-table" hx-trigger="keyup changed delay:300ms">
        <input 
            type="text" 
            id="article-search" 
            class="form-control form-control-sm" 
            placeholder="{% trans 'Search Articles' %}" 
            name="q"
            {% if LANGUAGE_CODE == 'ar' %}
                dir="rtl"
                style="padding-right: 10px; text-align: right;"
            {% else %}
                dir="ltr"
                style="padding-left: 10px; text-align: left;"
            {% endif %}
        />
      </form>
  
      {% if LANGUAGE_CODE == 'ar' %}
        <img src="{% static 'images/searchb.svg' %}" alt="{% trans 'Search Icon' %}"
            class="position-absolute top-50 start-0 translate-middle-y"
            style="width: 20px; height: 20px;">
      {% else %}
        <img src="{% static 'images/searchb.svg' %}" alt="{% trans 'Search Icon' %}"
            class="position-absolute top-50 end-0 translate-middle-y"
            style="width: 20px; height: 20px;">
      {% endif %}
    </div>

    <button type="button" class="btn btn-primary new-article-btn" data-bs-toggle="modal" data-bs-target="#newArticleModal">+{% trans 'New Article' %}</button>
    <a href="{% url 'articles:export_activity_log_excel' %}"><img src="{% static 'images/export.svg' %}" alt="{% trans 'Section Icon' %}" class="ms-2" /></a>
  </div>

  <div class="container-fluid mt-3">
    <div class="form-section">
      <div id="articles-table">
        {% include 'articles/partials/table.html' %}
      </div>
    </div>
  </div>

  {% include 'articles/partials/form.html' %}

  <script>
    document.getElementById('newArticleModal').addEventListener('hide.bs.modal', function () {
      document.getElementById('id').value = ''
      document.getElementById('title').value = ''
      document.getElementById('category').value = ''
      document.getElementById('short_description').value = ''
      CKEDITOR.instances['brief_description'].setData('')
    })

    // 🌍 Multi-language state
    window.currentArticleId = null;
    window.mainArticleId = null;
    window.currentLanguage = 'english';

    // 🌍 Fetch article with optional language param
    window.fetchArticleDetails = function(articleId, language = 'english') {
      window.currentArticleId = articleId;
      window.currentLanguage = language;

      fetch(`{% url 'articles:article_detail_api' '000' %}`.replace('000', articleId) + `?language=${language}`)
        .then((response) => response.json())
        .then((data) => {
          document.getElementById('id').value = data.id
          document.getElementById('title').value = data.title
          document.getElementById('short_description').value = data.short_description
          document.getElementById('current_language').value = data.current_language

          window.currentArticleId = data.id
          window.mainArticleId = data.main_id

          if (CKEDITOR.instances.brief_description) {
            CKEDITOR.instances.brief_description.destroy()
          }

          CKEDITOR.replace('brief_description', {
            height: 300,
            allowedContent: true,
            extraAllowedContent: 'img[*]{*}; p[*]{*}; figure[*]{*}; figcaption[*]{*};'
          })

          setTimeout(() => {
            CKEDITOR.instances.brief_description.setData(data.brief_description)
          }, 500)

          // ✅ Category selection
          const categorySelect = document.getElementById('category')
          const options = categorySelect.options
          for (let i = 0; i < options.length; i++) {
            if (options[i].text === data.category || options[i].value === data.category) {
              categorySelect.selectedIndex = i
              break
            }
          }

          // 🌍 Update language switcher UI
          const languageSwitcher = document.getElementById('languageSwitcher');
          if (languageSwitcher) {
            languageSwitcher.style.display = 'block';
            const languageDropdown = document.getElementById('languageDropdown');
            if (languageDropdown) {
              languageDropdown.innerHTML = data.current_language === 'english' ? '🇺🇸 English' : '🇸🇦 العربية';
            }
            const viewEnglish = document.getElementById('viewEnglish');
            const viewArabic = document.getElementById('viewArabic');
            if (viewEnglish && viewArabic) {
              if (!data.has_arabic) {
                viewArabic.innerHTML = '🇸🇦 العربية +';
                viewArabic.title = '{% trans "Create Arabic translation" %}';
              } else {
                viewArabic.innerHTML = '🇸🇦 العربية';
                viewArabic.title = '{% trans "View in Arabic" %}';
              }
              viewEnglish.innerHTML = '🇺🇸 English';
              viewEnglish.title = '{% trans "View in English" %}';
            }
          }

          // Modal title with language
          const modalTitle = document.getElementById('newArticleModalLabel');
          if (modalTitle) {
            modalTitle.innerHTML = `{% trans 'View Article' %} <small class="text-muted">(${data.current_language})</small>`;
          }

          var modal = new bootstrap.Modal(document.getElementById('newArticleModal'))
          modal.show()
        })
        .catch((error) => console.error('Error fetching article details:', error))
    }

    function setDeleteFormAction(targetId) {
      const deleteForm = document.getElementById('deleteForm')
      const deleteUrl = `{% url 'articles:delete' '000' %}`.replace('000', targetId)
      deleteForm.action = deleteUrl
    }

    function setStatusModalData(targetId, status) {
      const form = document.getElementById('statusUpdateForm')
      const actionUrl = `{% url 'articles:status' '000' %}`.replace('000', targetId)
      form.action = actionUrl

      let statusInput = form.querySelector('input[name="status"]')
      if (!statusInput) {
        statusInput = document.createElement('input')
        statusInput.type = 'hidden'
        statusInput.name = 'status'
        form.appendChild(statusInput)
      }
      statusInput.value = status
    }

    function setVisibilityModalData(targetId, visibility) {
      const form = document.getElementById('visibilityToggleForm')
      const actionUrl = `{% url 'articles:visibility' '000' %}`.replace('000', targetId)
      form.action = actionUrl

      let visibilityInput = form.querySelector('input[name="visibility"]')
      if (!visibilityInput) {
        visibilityInput = document.createElement('input')
        visibilityInput.type = 'hidden'
        visibilityInput.name = 'visibility'
        form.appendChild(visibilityInput)
      }
      visibilityInput.value = visibility
    }

    // File drop/upload handlers (unchanged)
    document.addEventListener('DOMContentLoaded', function () {
      const dropzone = document.getElementById('file-dropzone')
      const fileInput = document.getElementById('file_input')

      dropzone.addEventListener('dragover', (event) => {
        event.preventDefault()
        dropzone.classList.add('dragover')
      })

      dropzone.addEventListener('dragleave', () => {
        dropzone.classList.remove('dragover')
      })

      dropzone.addEventListener('drop', async (event) => {
        event.preventDefault()
        dropzone.classList.remove('dragover')
        const files = event.dataTransfer.files
        await handleFiles(files)
      })

      fileInput.addEventListener('change', async () => {
        const files = fileInput.files
        await handleFiles(files)
      })

      async function handleFiles(files) {
        const loader = document.getElementById('loader')
        if (files.length > 0) {
          loader.style.display = 'block'
          for (let i = 0; i < files.length; i++) {
            const file = files[i]
            const formData = new FormData()
            formData.append('file', file)

            try {
              const response = await fetch('/articles/process_file/', { method: 'POST', body: formData })
              if (!response.ok) { console.error('File upload failed.'); return }
              const data = await response.json()

              if (data.image_url && /\.(jpeg|jpg|png|gif|webp)$/i.test(data.image_url)) {
                const BASE_URL = window.location.origin
                const imageURL = data.image_url.startsWith('http') ? data.image_url : BASE_URL + data.image_url

                const img = document.createElement('img')
                img.alt = 'Uploaded Image'
                img.classList.add('d-block')
                img.style = 'max-width: 100%; max-height: 300px;'

                const backendImage = new Image()
                backendImage.crossOrigin = 'anonymous'
                backendImage.src = imageURL

                backendImage.onload = function () {
                  img.src = backendImage.src
                  const imgWrapper = document.createElement('div')
                  imgWrapper.classList.add('uploaded-image')
                  imgWrapper.appendChild(img)
                  setTimeout(() => {
                    let element = CKEDITOR.dom.element.createFromHtml(imgWrapper.outerHTML)
                    CKEDITOR.instances.brief_description.insertElement(element)
                  }, 300)
                }
              } else if (data.video_url && /\.(mp4|webm|ogg)$/i.test(data.video_url)) {
                const BASE_URL = window.location.origin
                const videoURL = data.video_url.startsWith('http') ? data.video_url : BASE_URL + data.video_url
                const video = document.createElement('video')
                video.src = videoURL
                video.controls = true
                video.classList.add('d-block', 'w-100')
                video.style = 'max-width: 100%; max-height: 400px;'

                const videoWrapper = document.createElement('div')
                videoWrapper.classList.add('uploaded-video')
                videoWrapper.appendChild(video)
                setTimeout(() => {
                  let element = CKEDITOR.dom.element.createFromHtml(videoWrapper.outerHTML)
                  CKEDITOR.instances.brief_description.insertElement(element)
                }, 300)
              } else if (data.content) {
                CKEDITOR.instances.brief_description.insertHtml(`<p><strong>Extracted Content:</strong> </p><p>${data.content.replace(/\n/g, '<br>')}</p>`)
              }
            } catch (error) {
              console.error('Error uploading file:', error)
            }
          }
          loader.style.display = 'none'
        } else {
          alert('Please upload at least one file.')
        }
      }
    })
  </script>
{% endblock %}
